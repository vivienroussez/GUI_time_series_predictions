#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(dplyr)
library(tidyr)
library(shiny)
library(autoTS)
library(ggplot2)
library(plotly)
library(lubridate)
library(shinycssloaders)

## Create dummy data for example
dates <- seq(lubridate::as_date("2005-01-01"),lubridate::as_date("2010-12-31"),"month")
ts1 <- 1:length(dates)/10 + rnorm(length(dates))
ts2 <- rnorm(length(dates),10,25)

ex <- data.frame(date=dates,var1=ts1,var2=ts2)

ui <- fluidPage(
  
  # Application title
  titlePanel("Time series predictions : AutoTS graphical interface"),
  
  fluidRow(
    # column(12,
    #        h3("How should my data look like ?"),
    #        dataTableOutput("example")
    # ),
    column(4,
           wellPanel(
             fileInput("file1", "Choose CSV File",
                       accept = c(
                         "text/csv",
                         "text/comma-separated-values,text/plain",
                         ".csv")
             ),
             uiOutput("select_date"),
             uiOutput("select_var"),
             selectInput("freq","Seasonality",c("day","week","month","quarter"),selected = "month"),
             selectInput("model_choice","Algorithm selection",
                         choices = list("ARIMA"="my.sarima","Prophet"="my.prophet",
                                        "ETS"="my.ets","BATS"="my.bats","TBATS"="my.tbats",
                                        "STL"="my.stlm","Short term"="my.shortterm","Bagged estimator"="my.bagged",
                                        "Best model"="best"),
                         selected = "best"),
             numericInput("test_length","Number of obs for test data",value = 12)
           )
    ),
    column(8,
           h3("Results of the training step"),
           plotlyOutput("train") %>%
             shinycssloaders::withSpinner(color = "#ff0000"),
           h3("Results of the predictions"),
           plotlyOutput("pred") %>%
             shinycssloaders::withSpinner(color = "#ff0000")
    )
    
    
    # Show a plot of the generated distribution
    
  )
)

# Define server logic required to draw a histogram
server <- function(input, output) {
  
  dat <- reactive({
    inFile <- input$file1
    if (is.null(inFile)) return(NULL)
    data <- read.csv(inFile$datapath, header = TRUE)
    return(data)
  })
  
  output$select_date <- renderUI({
    selectInput("date","Date variable",names(dat()),selected = names(dat())[1])
  })
  
  output$select_var <- renderUI({
    selectInput("var","Variable to predict",names(dat()),selected = names(dat())[2])
  })
  
  train <- reactive({
    validate(need(!is.null(dat()),"Waiting for data"))
    getBestModel(dat()[,input$date],dat()[,input$var],freq = input$freq,graph = F,n_test = input$test_length)
  })
  
  pred <- reactive({
    validate(need(!is.null(dat()),"Waiting for data"))
        data_ts <- prepare.ts(dat()[,input$date],dat()[,input$var],freq = input$freq)
    if (input$model_choice=="best") res <- my.predictions(data_ts,train()$best)
    else res <- my.predictions(data_ts,input$model_choice)
    return(res)
  })
  
  output$train <- renderPlotly({
    train()$graph.train + theme_light()
  })
  
  output$pred <- renderPlotly({
    dd <- pred()
    gather(dd,key="var",value = "val",-dates,-type) %>% 
      mutate(type=ifelse(var=="actual.value","mean",type)) %>% 
      filter(type=="mean") %>% 
      ggplot(aes(dates,val,color=var)) + geom_line() + theme_light()
  })
  
}


# Run the application 
shinyApp(ui = ui, server = server)

